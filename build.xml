<project name="Salesforce Sandbox Ant Tasks" default="help" basedir="."
  xmlns:sf="antlib:com.salesforce">
  <property name="dir.logs" location="logs"/>
  <property name="dir.lib" location="lib"/>
  <property name="dir.deploy" location="deploy"/>
  <property name="dir.deploy.backup.sandbox" location="deploy/backup/sandbox"/>
  <property name="dir.deploy.backup.production" location="deploy/backup/production"/>
  <property name="dir.retrieve" location="retrieve"/>
  <property name="dir.retrieve.sandbox" location="retrieve/sandbox"/>
  <property name="dir.retrieve.production" location="retrieve/production"/>
  <property name="dir.undeploy" location="deploy"/>
  <property name="dir.undeploy.backup.sandbox" location="deploy"/>
  <property name="dir.undeploy.backup.production" location="production"/>
  <property name="file.pkg" location="package.xml"/>
  <property name="file.deploy.pkg" location="deploy/package.xml"/>
  <property name="file.retrieve.sandbox.pkg" location="retrieve/sandbox/package.xml"/>
  <property name="file.retrieve.production.pkg" location="retrieve/production/package.xml"/>
  <property name="file.undeploy.destuctive-changes" location="undeploy/production/destructiveChanges.xml"/>
  <property name="file.undeploy.destuctive-changes-pre" location="undeploy/production/destructiveChangesPre.xml"/>
  <property name="file.undeploy.destuctive-changes-post" location="undeploy/production/destructiveChangesPost.xml"/>
  <property file="build.properties"/>
  <property file="default.properties"/>
  <property file="library.properties"/>
  <property name="lib.sf-ant.jar" location="${dir.lib}/${sf-ant.name}-${sf-ant.version}.jar"/>
  <property name="lib.junit.jar" location="${dir.lib}/${junit.name}-${junit.version}.jar"/>
  <property name="lib.hamcrest-core.jar" location="${dir.lib}/${hamcrest-core.name}-${hamcrest-core.version}.jar"/>

  <taskdef resource="com/salesforce/antlib.xml" uri="antlib:com.salesforce">
    <classpath>
      <pathelement location="${lib.sf-ant.jar}"/>
    </classpath>
  </taskdef>

  <path id="classpath.test">
    <pathelement location="${lib.junit.jar}"/>
    <pathelement location="${lib.hamcrest.jar}"/>
    <pathelement location="${lib.main.build.dir}"/>
  </path>

  <target name="-init" depends="-setCredentials,-syncPackageXmls">
    <mkdir dir="${dir.logs}"/>
    <tstamp>
      <format property="tstamp" pattern="yyyyMMddhhmm" locale="en,US"/>
    </tstamp>
  </target>

  <target name="-closeout" depends="-resetPackageXmls">
    <delete>
      <fileset dir="." includes="**/*.ant-targets-build.xml" quiet="true"/>
    </delete>
  </target>

  <target name="-setCredentials">
    <condition property="sf.username" value=""> <not> <isset property="sf.username"/> </not> </condition>
    <condition property="sf.password" value=""> <not> <isset property="sf.password"/> </not> </condition>
    <condition property="sf.sessionId" value=""> <not> <isset property="sf.sessionId"/> </not> </condition>
  </target>

  <target name="-syncPackageXmls">
    <move file="${file.retrieve.sandbox.pkg}" tofile="${file.retrieve.sandbox.pkg}-copy" preservelastmodified="true" overwrite="true"/>
    <move file="${file.retrieve.production.pkg}" tofile="${file.retrieve.production.pkg}-copy" preservelastmodified="true" overwrite="true"/>
    <copy file="${file.deploy.pkg}" tofile="{file.retrieve.sandbox.pkg}" preservelastmodified="true" overwrite="true"/>
    <copy file="${file.deploy.pkg}" tofile="{file.retrieve.production.pkg}" preservelastmodified="true" overwrite="true"/>
  </target>

  <target name="-resetPackageXmls">
    <move file="${file.retrieve.sandbox.pkg}-copy" tofile="${file.retrieve.sandbox.pkg}" preservelastmodified="true" overwrite="true"/>
    <move file="${file.retrieve.production.pkg}-copy" tofile="${file.retrieve.production.pkg}" preservelastmodified="true" overwrite="true"/>
  </target>

  <target name="-logproperties">
    <touch file="${dir.logs}/my.properties"/>
    <echoproperties destfile="${dir.logs}/my.properties">
      <propertyset>
        <propertyref prefix="sf."/>
        <propertyref prefix="server."/>
        <propertyref prefix="value."/>
        <propertyref prefix="value."/>
        <propertyref prefix="lib."/>
      </propertyset>
    </echoproperties>
  </target>

  <target name="-printproperties" depends="-logproperties">
    <loadfile property="myproperties" srcFile="${dir.logs}/my.properties"/> 
    <echo>${myproperties}</echo> 
  </target>

  <macrodef name="-getRequestId">
    <attribute name="srcFile"/>
    <sequential>
      <loadfile srcFile="@{srcFile}" property="dev.deploy.requestId">
        <filterchain>
          <tailfilter lines="1"/>
          <tokenfilter>
            <stringtokenizer suppressdelims="true"/>
            <containsregex pattern="[a-zA-Z0-9]{18}"/>
          </tokenfilter>
        </filterchain>
      </loadfile>
    </sequential>
  </macrodef>

  <target name="-logRequestId" depends="-setRequestIdFromDeployLog">
    <-getRequestId srcFile="${dir.logs}/deploylog.txt"/>
  <echo file="${dir.logs}/request-ids.txt" append="true"
    message="${line.separator}${tstamp}: ${dev.deploy.root}=>${dev.deploy.serverurl}  ${dev.deploy.requestId}"/>
</target>

  <target name="-setDeployServerurl">
    <loadfile srcFile="${dir.logs}/request-ids.txt" property="dev.deploy.serverurl">
      <filterchain>
        <tailfilter lines="1"/>
        <tokenfilter>
          <stringtokenizer suppressdelims="true"/>
          <containsregex pattern="\=\>"/>
        </tokenfilter>
        <tokenfilter>
          <stringtokenizer suppressdelims="true"/>
          <containsregex pattern=".+\=\>(\S+)" replace="\1"/>
        </tokenfilter>
      </filterchain>
    </loadfile>
  </target>

  <target name="help" description="List properties and targets" depends="-init">
    <antcall target="-printproperties"/>
    <java classname="org.apache.tools.ant.Main">
      <arg value="${ant.file}"/>
    </java>
  </target>

  <target name="clean" description="Destroy all generated files and dirs">
    <delete>
      <fileset dir="." includes="**/*.ant-targets-build.xml" quiet="true"/>
    </delete>
    <delete includeemptydirs="true">
      <fileset dir="${dir.deploy.backup}" includes="**/*" erroronmissingdir="false"/>
      <fileset dir="${dir.retrieve}" excludes="package.xml" erroronmissingdir="false"/>
      <fileset dir="${dir.undeploy}" excludes="*.xml" erroronmissingdir="false"/>
      <fileset dir="${dir.logs}" erroronmissingdir="false"/>
    </delete>
  </target>

  <macrodef name="describeMetadata">
    <attribute name="org" default="sandbox"/>
    <attribute name="serverurl" default="${server.sandbox}"/>
    <sequential>
      <touch file="${dir.logs}/describe-@{org}.log"/>
      <sf:describeMetadata username="${sf.username}" password="${sf.password}" sessionId="${sf.sessionId}" serverurl="@{serverurl}"
        resultFilePath="${dir.logs}/describe-@{org}.log"/>
    </sequential>
  </macrodef>

  <macrodef name="listMetadata">
    <attribute name="org" default="sandbox"/>
    <attribute name="serverurl" default="${server.sandbox}"/>
    <attribute name="metadataType"/ defaults="AuraDefinitionBundle">
    <sequential>
      <touch file="${dir.logs}/list-@{org}.log"/>
      <sf:listMetadata username="${sf.username}" password="${sf.password}" sessionId="${sf.sessionId}" serverurl="@{serverurl}"
        resultFilePath="${dir.logs}/list-@{org}.log" metadataType="@{metadataType}"/>
    </sequential>
  </macrodef>

  <macrodef name="retrieve">
    <attribute name="org" default="sandbox"/>
    <attribute name="serverurl" default="${server.sandbox}"/>
    <attribute name="retrieveTarget" default="${dir.retrieve.sandbox}"/>
    <attribute name="pkg" default="${file.retrieve.sandbox.pkg}"/>
    <sequential>
      <delete includeemptydirs="true">
        <fileset dir="@{retrieveTarget}" erroronmissingdir="false"/>
      </delete>
      <mkdir dir="@{retrieveTarget}"/>
      <sf:retrieve username="${sf.username}" password="${sf.password}" sessionId="${sf.sessionId}" serverurl="@{serverurl}"
        maxPoll="${server.maxPoll}" retrieveTarget="@{retrieveTarget}" unpackaged="@{pkg}"/>
    </sequential>
  </macrodef>

  <macrodef name="deploy">
    <attribute name="org" default="sandbox"/>
    <attribute name="serverurl" default="${server.sandbox}"/>
    <attribute name="deployRoot" default="${dir.deploy}"/>
    <attribute name="backupRoot" default="${dir.deploy.backup.sandbox}"/>
    <sequential>
      <if>
        <equals arg1="@{deployRoot}" arg2="${dir.deploy}"/>
        <then>
          <retrieve org="@{org}" serverurl="@{serverurl}" retrieveTarget="@{backupRoot}" pkg="${file.deploy.pkg}"/>
        </then>
        <elseif>
          <equals arg1="@{deployRoot}" arg2="${dir.undeploy}"/>
          <then>
            <retrieve org="@{org}" serverurl="@{serverurl}" retrieveTarget="@{backupRoot}" pkg="${file.undeploy.destructive-changes}"/>
            <retrieve org="@{org}" serverurl="@{serverurl}" retrieveTarget="@{backupRoot}" pkg="${file.undeploy.destructive-changes-pre}"/>
            <retrieve org="@{org}" serverurl="@{serverurl}" retrieveTarget="@{backupRoot}" pkg="${file.undeploy.destructive-changes-post}"/>
          </then>
        </elseif>
        <else>
          <fail message="Must deploy from a deployRoot directory of 'deploy' or 'undeploy'."/>
        </else>
      </if>
      <record name="${dir.logs}/deploylog.txt" action="start"/>
      <sf:deploy username="${sf.username}" password="${sf.password}" sessionId="${sf.sessionId}" serverurl="@{serverurl}"
        maxPoll="${server.maxPoll}" deployRoot="@{deployRoot}" rollbackOnError="true" ignoreWarnings="false"/>
      <record name="${dir.logs}/deploylog.txt" action="stop"/>
      <property name="dev.deploy.serverurl" value="@{serverurl}"/>
      <property name="dev.deploy.root" value="@{deployRoot}"/>
      <antcall target="-logRequestId"/>
    </sequential>
  </macrodef>

  <macrodef name="cancelDeploy">
    <sequential>
      <-getRequestId srcFile="${dir.logs}/request-ids.txt"/>
      <antcall target="-setDeployServerurl"/>
      <sf:cancelDeploy  username="${sf.username}" password="${sf.password}" sessionId="${sf.sessionId}" serverurl="${dev.deploy.serverurl}"
        maxPoll="${server.maxPoll}" requestId="${dev.deploy.requestId}"/>
    </sequential>
  </macrodef>

  <target name="describeSandboxMetadata" depends="-init" description="">
    <describeMetadata org="sandbox" serverurl="${server.sandbox}"/>
    <antcall target="-closeout"/>
  </target>

  <target name="describeProductionMetadata" depends="-init" description="" >
    <describeMetadata org="production" serverurl="${server.production}"/>
    <antcall target="-closeout"/>
  </target>

  <target name="listSandboxMetadata" depends="-init" description="Retrieve information on all items of a particular metadatatype" >
    <listMetadata org="sandbox" serverurl="${server.sandbox}" metadataType="${value.metadataType}"/>
    <antcall target="-closeout"/>
  </target>

  <target name="listProductionMetadata" depends="-init" description="">
    <listMetadata org="production" serverurl="${server.production}" metadataType="${value.metadataType}"/>
    <antcall target="-closeout"/>
  </target>

  <target name="retrieveSandbox" depends="-init" description="">
    <retrieve org="sandbox" serverurl="${server.sandbox}" retrieveTarget="${dir.retrieve.sandbox}" pkg="${file.retrieve.sandbox.pkg}"/>
    <antcall target="-closeout"/>
  </target>

  <target name="retrieveProduction" depends="-init" description="">
    <retrieve org="production" serverurl="${server.production}" retrieveTarget="${dir.retrieve.production}" pkg="${file.retrieve.production.pkg}"/>
    <antcall target="-closeout"/>
  </target>

  <target name="deployToSandbox" depends="-init" description="">
    <deploy org="sandbox" serverurl="${server.sandbox}" deployRoot="${dir.deploy}" backupRoot="${dir.deploy.backup.sandbox}"/>
    <antcall target="-closeout"/>
  </target>

  <target name="deployToProduction" depends="-init" description="">
    <deploy org="production" serverurl="${server.production}" deployRoot="${dir.deploy}" backupRoot="${dir.deploy.backup.production}"/>
    <antcall target="-closeout"/>
  </target>

  <target name="undeployFromSandbox" depends="-init" description="">
    <deploy org="sandbox" serverurl="${server.sandbox}" deployRoot="${dir.undeploy}" backupRoot="${dir.undeploy.backup.sandbox}"/>
    <antcall target="-closeout"/>
  </target>

  <target name="undeployFromProduction" depends="-init" description="">
    <deploy org="production" serverurl="${server.production}" deployRoot="${dir.undeploy}" backupRoot="${dir.undeploy.backup.production}"/>
    <antcall target="-closeout"/>
  </target>

  <target name="cancelLastDeploy" depends="-init" description="">
    <cancelDeploy/>
    <antcall target="-closeout"/>
  </target>

</project>
